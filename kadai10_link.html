<!doctype html>
<meta charset="utf-8">
<title>7-5′ Platform Landing</title>
<canvas id="cv" width="640" height="360" style="background:#0e1528"></canvas>
<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

// ── オブジェクト ─────────────────────────
const player = { x: 80, y: 260, w: 28, h: 36 };
const floor  = { x: 0,  y: 320, w: 640, h: 40 };
const plat   = { x: 440, y: 200, w: 160, h: 16 };
const plat2  = { x: 40,  y: 200, w: 160, h: 16 };

// ── 物理パラメータ ────────────────────────
let vx = 0;
let vy = 0;
const speed = 240;
const jump  = 900;
const g     = 2000;
let isGrounded = false;
const bounce  = 0.45;
const impact  = 250;
friction = 0.88;

// ── 入力 ──────────────────────────────────
const keys = {};
addEventListener('keydown', e => keys[e.key] = true);
addEventListener('keyup',   e => keys[e.key] = false);

addEventListener('keydown', e=>{
  if (e.code === 'Space' && isGrounded) vy = -jump;
});

// ── 衝突処理：床 ───────────────────────────
function collideWithFloor(){
  const bottom = player.y + player.h;
  if (bottom > floor.y) {
    player.y = floor.y - player.h;
    if (Math.abs(vy) > impact) {
      vy = -vy * bounce;
      isGrounded = false;
    } else {
      vy = 0;
      isGrounded = true;
    }
  } else {
    isGrounded = false;
  }
}

// ── 当たり判定ユーティリティ（AABB） ──────
function aabb(r1, r2) {
  return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
          r1.y < r2.y + r2.h && r1.y + r1.h > r2.y);
}

// ── 衝突処理：浮遊足場（★今回の変更：統一版） ──
function collideWithPlatform(dt, platform) {
  const pNow = { x: player.x, y: player.y, w: player.w, h: player.h };
  if (!aabb(pNow, platform)) return;

  const prevBottom = (player.y - vy * dt) + player.h;
  const platformTop = platform.y;

  if (prevBottom <= platformTop && vy >= 0) {
    player.y = platformTop - player.h;
    vy = 0;
    isGrounded = true;
      if (player.x < 200){
        vx += 60;
        }
        else{
        vx -= 60;
      }
  }
}

// ── 位置更新（元のまま）─────────────────────
function update(dt){
  if (keys['ArrowLeft'])  vx = -speed;
  else if (keys['ArrowRight']) vx = speed;
  else if (isGrounded) vx *= friction;

  player.x += vx * dt;
  vy += g * dt;
  player.y += vy * dt;

  isGrounded = false;
  collideWithFloor();

  collideWithPlatform(dt, plat);
  collideWithPlatform(dt, plat2);
}

// ── 描画（元のまま）────────────────────────
function draw() {
  ctx.clearRect(0,0,cv.width,cv.height);

  ctx.fillStyle = '#203060';
  ctx.fillRect(floor.x, floor.y, floor.w, floor.h);

  ctx.fillStyle = '#DE11FA';
  ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
  ctx.fillStyle = '#AF11ED';
  ctx.fillRect(plat2.x, plat2.y, plat2.w, plat2.h);

  ctx.fillStyle = isGrounded ? '#7ef5e1' : '#ffd166';
  ctx.fillRect(player.x, player.y, player.w, player.h);

  ctx.fillStyle = '#cbd5e1';
  ctx.font = '12px ui-monospace,monospace';
  ctx.fillText(`vy=${vy.toFixed(1)} grounded=${isGrounded}`, 8, 16);
}

// ── ループ（元のまま）──────────────────────
let last = performance.now();
function loop(now) {
  const dt = (now - last) / 1000; last = now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>